<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Tree</title>
<script src="https://gvssmark.github.io/FamTree/gvss.json"></script>
<style>
    body { font-family: Arial; font-size:small; margin:0; }
    .tree-container { padding: 10px; }
    .node {display: flex; flex-direction: row; align-items: center; justify-content: flex-start; padding: 5px; border: 1px solid #444; border-radius: 10px; cursor: pointer; margin: 5px; text-align: left; transition: 0.2s; min-width: 220px; }
    .children { margin-left: 2px; border-left: 1px solid #bbb; padding-left: 10px; display: none; }
    .visible { display: block !important; }
    .photo { width: 30px; height: 30px; object-fit: cover; border-radius: 50%; margin-right: 10px; border:1px solid black; }
    .text { display: flex; flex-direction: column; justify-content: center; }
    .two-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
    .surname { cursor:pointer; padding:5px; border:1px solid #444; border-radius:5px; margin:3px; text-align:center; background:#f7f7f7; }
    .member { cursor:pointer; padding:5px; border:1px solid #444; border-radius:5px; margin:3px; background:#f7f7f7; }
    .topbar {position:fixed; top:0; left:0; right:0; background:#eee; padding:10px; border-bottom:1px solid #444; text-align:center; z-index:1000; display:flex; flex-direction:column; align-items:center; gap:6px;  }
    .title { margin:0; font-weight:bold; color:#d00; }
    .buttons { display:flex; gap:8px; flex-wrap:wrap; }
    .buttons button { margin:0; padding:6px 12px; }
    .content { margin-top:90px; }
</style>
</head>
<body>

<div class="topbar">
    <div class="title" id="title">Family Tree</div>
    <div class="buttons">
        <button id="paternalBtn" disabled>Paternal</button>
        <button id="maternalBtn" disabled>Maternal</button>
        <button id="fatherMotherBtn" disabled>Father's Mother</button>
        <button id="motherFatherBtn" disabled>Mother's Father</button>
        <button id="homeBtn">Home</button>
    </div>
</div>

<!-- Screens -->
<div id="screen1" class="two-columns content"></div>
<div id="screen2" class="content" style="display:none;"></div>
<div id="screen3" class="content" style="display:none;"></div>
<div id="tree" class="tree-container content" style="display:none;"></div>

<script>
// ------------------ Input Data ------------------
const raw = gvss;
// ------------------------------------------------
const data = raw.slice(1).map(r => ({
    id: Number(r[0]),
    name: r[1],
    gender: r[2],
    father: r[3] === "" ? null : Number(r[3]),
    mother: r[4] === "" ? null : Number(r[4]),
    spouse: r[5] === "" ? null : Number(r[5]),
    dob: r[6],
    telugu: r[7]
}));

const persons = {};
data.forEach(p => { persons[p.id] = { ...p, children: [] }; });
data.forEach(p => {
    if (p.father && persons[p.father]) persons[p.father].children.push(p.id);
    if (p.mother && persons[p.mother]) persons[p.mother].children.push(p.id);
});

// Colors
const genColors = ["#cce6ff","#d5f5d5","#fff4b3","#ffd6e7","#e0e0e0", "#C9901D", "#56C91D", "#ACC91D"];

function formatDOB(dob) {
    if (!dob) return "";
    const date = new Date(dob);
    return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
}

// Build node
function buildNode(person, level) {
    const wrap = document.createElement("div");
    const node = document.createElement("div");
    node.className = "node";
    node.style.background = genColors[level] || "#f7f7f7";

    const photo = document.createElement("img");
    photo.className = "photo";
    photo.src = `https://gvssmark.github.io/FamTree/photos/${person.id}.JPG`;
    photo.onerror = () => { photo.style.display = "none"; };

    const textDiv = document.createElement("div");
    textDiv.className = "text";
    let nameLine = `<b>${person.name}`;
    if (person.dob) nameLine += ` (${formatDOB(person.dob)})`;
    nameLine += `</b>`;

    let spouseLine = "";
    if (person.spouse && persons[person.spouse]) {
        const sp = persons[person.spouse];
        spouseLine = `<span style='font-size:12px;color:blue'>${sp.name}`;
        if (sp.dob) spouseLine += ` (${formatDOB(sp.dob)})`;
        spouseLine += `</span>`;
    }

    textDiv.innerHTML = `${nameLine}${spouseLine}`;

    node.appendChild(photo);
    node.appendChild(textDiv);

    const kids = document.createElement("div");
    kids.className = "children";
    node.onclick = () => kids.classList.toggle("visible");

    person.children.forEach(cid => {
        kids.appendChild(buildNode(persons[cid], level + 1));
    });

    wrap.appendChild(node);
    if (person.children.length > 0) wrap.appendChild(kids);
    return wrap;
}

// ---------- Screen 1: Surnames ----------
const screen1 = document.getElementById("screen1");
const surnames = [...new Set(data.map(p => p.name.split(" ")[0]))]
    .sort((a,b) => a.localeCompare(b));

surnames.forEach(sn => {
    const div = document.createElement("div");
    div.className = "surname";
    div.textContent = sn;
    div.onclick = () => showMembers(sn);
    screen1.appendChild(div);
});

// ---------- Screen 2: Members ----------
function showMembers(surname) {
    setTitle(`Members of ${surname}`);
    screen1.style.display = "none";

    const screen2 = document.getElementById("screen2");
    screen2.innerHTML = "";
    screen2.style.display = "block";

    data
        .filter(p => p.name.startsWith(surname))
        .sort((a,b) => a.name.localeCompare(b.name))
        .forEach(p => {
            const div = document.createElement("div");
            div.className = "member";
            div.textContent = p.name;
            div.onclick = () => showMemberOptions(p.id);
            screen2.appendChild(div);
        });

    setButtonsEnabled(false);
    document.getElementById("tree").style.display = "none";
    document.getElementById("screen3").style.display = "none";
    window.scrollTo(0,0);
}

// ---------- Screen 3 ----------
let currentPersonId = null;

function showMemberOptions(id) {
    currentPersonId = id;
    setTitle(persons[id].name);

    document.getElementById("screen2").style.display = "none";
    document.getElementById("screen3").style.display = "block";
    document.getElementById("tree").style.display = "none";

    setButtonsEnabled(true);
    window.scrollTo(0,0);
}

// ---------- Root Ancestor ----------
function showRootAncestor(start, side) {
    let current = typeof start === "number" ? persons[start] : start;

    while (current && current[side]) {
        current = persons[current[side]];
    }
    if (!current) return;

    const originalName = persons[currentPersonId].name;
    let label = "";

    if (side === "father") label = "Paternal Tree of ";
    if (side === "mother") label = "Maternal Tree of ";

    setTitle(label + originalName);

    document.getElementById("screen3").style.display = "none";

    const treeDiv = document.getElementById("tree");
    treeDiv.innerHTML = "";
    treeDiv.style.display = "block";
    treeDiv.appendChild(buildNode(current, 0));

    window.scrollTo(0,0);
}

// ---------- Buttons ----------
document.getElementById("homeBtn").onclick = () => {
    setTitle("Family Tree");
    document.getElementById("screen1").style.display = "grid";
    document.getElementById("screen2").style.display = "none";
    document.getElementById("screen3").style.display = "none";
    document.getElementById("tree").style.display = "none";
    currentPersonId = null;

    setButtonsEnabled(false);
    window.scrollTo(0,0);
};

document.getElementById("paternalBtn").onclick = () => {
    if (currentPersonId) showRootAncestor(currentPersonId, "father");
};

document.getElementById("maternalBtn").onclick = () => {
    if (currentPersonId) showRootAncestor(currentPersonId, "mother");
};

// NEW: Father → Mother → Ancestor
document.getElementById("fatherMotherBtn").onclick = () => {
    if (!currentPersonId) return;
    let p = persons[currentPersonId];
    if (p.father && persons[p.father].mother) {
        showRootAncestor(persons[p.father].mother, "mother");
    }
};

// NEW: Mother → Father → Ancestor
document.getElementById("motherFatherBtn").onclick = () => {
    if (!currentPersonId) return;
    let p = persons[currentPersonId];
    if (p.mother && persons[p.mother].father) {
        showRootAncestor(persons[p.mother].father, "father");
    }
};

// ---------- Helpers ----------
function setTitle(text) {
    document.getElementById("title").textContent = text;
}

function setButtonsEnabled(enabled) {
    document.getElementById("paternalBtn").disabled = !enabled;
    document.getElementById("maternalBtn").disabled = !enabled;
    document.getElementById("fatherMotherBtn").disabled = !enabled;
    document.getElementById("motherFatherBtn").disabled = !enabled;
}
</script>
</body>
</html>
