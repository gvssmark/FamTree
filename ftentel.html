<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Family Tree</title>
<script src="https://gvssmark.github.io/FamTree/index.js" defer></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins&effect=neon|outline|emboss|shadow-multiple">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Anek+Telugu:wght@400;500;700&display=swap">
<link rel="manifest" href="https://gvssmark.github.io/FamTree/manifest.json">
<meta name="theme-color" content="#317EFB"/>
<script src="https://gvssmark.github.io/FamTree/gvss.json"></script>
<style>
body { 
    font-family: Poppins, sans-serif; 
    text-shadow: 3px 3px 3px #ababab; 
    font-size: 12px; 
    margin: 0; 
    transition: font-family 0.3s ease;
}
body.telugu {
    font-family: 'Anek Telugu', sans-serif;
}
.tree-container { padding: 10px; max-width: 800px; margin: auto; }
.node {
    display: flex; flex-direction: row; align-items: center; justify-content: flex-start;
    padding: 5px; border: 1px solid #444; border-radius: 10px;
    cursor: pointer; margin: 5px; text-align: left; transition: 0.2s; min-width: 220px;
    position: relative;
}
.children { margin-left: 2px; border-left: 1px solid #bbb; padding-left: 10px; }
.collapsed { display:none; }
.expanded { display:block; }
.photo {
    width: 60px; height: 60px; object-fit: cover; border-radius: 50%;
    margin-right: 10px; border:1px solid black; background:#fff;
}
.photo.clickable { cursor: pointer; }
.text { display: flex; flex-direction: column; justify-content: center; }
.two-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; max-width: 800px; margin: auto; }
.surname, .member {
    cursor:pointer; padding:5px; border:1px solid #444; border-radius:5px;
    margin:3px; background:#f7f7f7; text-align:center;
}
.topbar {
    position:fixed; top:0; left:0; right:0;
    background:#eee; padding:10px; border-bottom:1px solid #444;
    text-align:center; z-index:1000;
    display:flex; flex-direction:column; align-items:center; gap:6px;
    max-width: 800px; margin: auto;
}
.title { margin:0; font-weight:bold; color:#d00; }
.buttons { display:flex; gap:8px; flex-wrap:wrap; }
.buttons button { padding:6px 12px; }
.content { margin: 122px auto 0 auto; }
/* NEW INTRO SCREEN STYLES */
#screen0 {
    max-width: 800px; margin: -28px auto 0 auto; padding: 20px; text-align: left;
    font-size: 14px; line-height: 1.6;
}
#screen0 h1 {
    text-align: center; color: #d00; font-size: 2.5em; margin-bottom: 30px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
#screen0 ul {
    list-style: none; padding-left: 0; margin-bottom: 30px;
}
#screen0 li {
    margin-bottom: 12px; padding: 5px; background: #f8f9fa;
    border-left: 4px solid #d00; padding-left: 5px;
    border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
#screen0 b { color: #d00; }

/* LANGUAGE SWITCH */
.language-switch {
    display: flex; align-items: center; gap: 10px; margin: 20px auto; justify-content: center;
}
.language-toggle {
    position: relative; display: inline-block; width: 60px; height: 34px;
}
.language-toggle input {
    opacity: 0; width: 0; height: 0;
}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: 0.3s; border-radius: 34px;
}
.slider:before {
    position: absolute; content: ""; height: 26px; width: 26px; left: 4px;
    bottom: 4px; background-color: white; transition: 0.3s;
    border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
input:checked + .slider {
    background-color: #d00;
}
input:checked + .slider:before {
    transform: translateX(26px);
}
.language-labels {
    font-weight: bold; font-size: 14px; color: #333;
}
#langStatus {
    font-weight: bold; margin-left: 10px; padding: 4px 8px;
    border-radius: 4px; background: #f0f0f0;
}

.continue-btn {
    background: #d00 !important; width:150px; height:30px; color:white; margin: auto;
    outline: none; display: flex; align-items: center; justify-content: center;
    font-size: x-large; border-radius: 25px; padding: 10px; cursor: pointer;
    transition: all 0.3s ease; border: none; font-weight: bold;
}
.continue-btn:hover {
    transform: translateY(-2px); box-shadow: 0 4px 12px rgba(208,0,0,0.4);
}
/* Generation badge */
.gen-badge-circle {
    position:absolute; top:5px; right:4px;
    width:22px; height:22px; background:black; color:white;
    border-radius:50%; display:flex; justify-content:center;
    align-items:center; font-size:11px; font-weight:bold;
}
.idno { font-size:xx-small; color:red; display:none; }
/* Search dropdown */
#searchResults {
    position: absolute;
    top: 105px;
    width: 90%; max-width: 720px;
    background: white;
    border: 1px solid #666;
    border-radius: 5px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 2000;
    display: none;
    box-shadow: 0 2px 6px rgba(0,0,0,.3);
}
.search-item {
    padding: 8px; border-bottom: 1px solid #ddd;
    cursor: pointer; background: #fafafa;
}
.search-item:hover { background:#e0e0e0; }
/* highlight found person */
.search-highlight {
    border: 3px solid orange !important;
    box-shadow: 0 0 10px orange !important;
}
</style>
</head>
<body>
<!-- NEW INTRO SCREEN -->
<div id='screen0'>
<h1 id="screenTitle">Family Tree</h1>

<div class="language-switch">
    <span class="language-labels">English</span>
    <label class="language-toggle">
        <input type="checkbox" id="languageToggle" onchange="toggleLanguage()">
        <span class="slider"></span>
    </label>
    <span class="language-labels">తెలుగు</span>
    <span id="langStatus">English</span>
</div>

<ul id="instructionsList">
<li>This data is having <b><span id='arraycount'></span></b> persons. You may be one among them</li>
<li>Click on a <b>Surname</b> will list all persons with that surname. Click on a <b>NAME</b> from the list will show the available Paternal root of that person.</li>
<li>Click on a <b>Maternal button</b> will show the available Maternal root of that person.</li>
<li>Click on a <b>Expand All button</b> will expand the full family tree and will scroll to that person.</li>
<li>Click on a <b>Collapse All button</b> will collapse the entire tree.</li>
<li>Click on a <b>Person</b> will expand that generation siblings. This is a toggle switch <b>(Expand / Collapse)</b>. You can deep dive in the tree.</li>
<li>Click on the <b>Photo</b> will switch to that person's spouse tree (if having spouse) / that person's tree</li>
<li>Click on <b>Home</b> will take you to Surnames list.</li>
<li>For persons having <b>more than one spouse</b>, click on the <b>spouse name</b> will switch the tree.</li>
</ul>

<div class="continue-btn" id="continueBtn">Continue</div>
<br>
</div>

<div class="topbar" style="display: none;">
<div class="title" id="title">Family Tree - Loading Photos...</div>
<div class="buttons" id="buttonsContainer">
<button id="paternalBtn" disabled>Paternal</button>
<button id="maternalBtn" disabled>Maternal</button>
<button id="expandAllToggle" disabled style="font-size:14px;">Expand All</button>
<button id="homeBtn">Home</button>
</div>
<input id="searchBox" type="text" placeholder="Search name…" style="width:90%; padding:6px; font-size:16px; border:1px solid #444; border-radius:5px;">
<div id="searchResults"></div>
</div>

<div id="screen1" class="two-columns content" style="display: none;"></div>
<div id="screen2" class="content" style="display: none;"></div>
<div id="tree" class="tree-container content" style="display: none;"></div>

<script>
let isTelugu = false;

// ✅ FIXED BUTTON TEXTS - PROPER STATE TRACKING
let buttonTexts = {
    english: {
        paternal: "Paternal",
        maternal: "Maternal", 
        expandAll: "Expand All",
        collapseAll: "Collapse All",
        home: "Home",
        searchPlaceholder: "Search name…"
    },
    telugu: {
        paternal: "తండ్రి",
        maternal: "తల్లి", 
        expandAll: "అన్నింటినీ విస్తరించు",
        collapseAll: "అన్నింటినీ మూసివేయి",
        home: "హోమ్",
        searchPlaceholder: "పేరు వెతకండి…"
    }
};

let englishTexts = {
    title: "Family Tree",
    instructions: [
        "This data is having <b><span id='arraycount'></span></b> persons. You may be one among them",
        "Click on a <b>Surname</b> will list all persons with that surname. Click on a <b>NAME</b> from the list will show the available Paternal root of that person.",
        "Click on a <b>Maternal button</b> will show the available Maternal root of that person.",
        "Click on a <b>Expand All button</b> will expand the full family tree and will scroll to that person.",
        "Click on a <b>Collapse All button</b> will collapse the entire tree.",
        "Click on a <b>Person</b> will expand that generation siblings. This is a toggle switch <b>(Expand / Collapse)</b>. You can deep dive in the tree.",
        "Click on the <b>Photo</b> will switch to that person's spouse tree (if having spouse) / that person's tree",
        "Click on <b>Home</b> will take you to Surnames list.",
        "For persons having <b>more than one spouse</b>, click on the <b>spouse name</b> will switch the tree."
    ],
    langStatus: "English"
};

let teluguTexts = {
    title: "కుటుంబ వృక్షం",
    instructions: [
        "ఈ డేటాలో <b><span id='arraycount'></span></b> మంది వ్యక్తులు ఉన్నారు. మీరు వారిలో ఒకరు కావచ్చు",
        "<b>అనుబంధం</b> పై క్లిక్ చేస్తే ఆ అనుబంధం ఉన్న అందరి పేర్లు వస్తాయి. ఆ పేర్లలో నుండి <b>పేరు</b> పై క్లిక్ చేస్తే ఆ వ్యక్తి తండ్రి వైపు మూలం చూపిస్తుంది.",
        "<b>తల్లి బొటన్</b> పై క్లిక్ చేస్తే ఆ వ్యక్తి తల్లి వైపు మూలం చూపిస్తుంది.",
        "<b>అన్నింటినీ విస్తరించు బొటన్</b> పై క్లిక్ చేస్తే పూర్తి కుటుంబ వృక్షం విస్తరించి ఆ వ్యక్తి వద్ద స్క్రోల్ అవుతుంది.",
        "<b>అన్నింటినీ మూసివేయి బొటన్</b> పై క్లిక్ చేస్తే మొత్తం వృక్షం మూసివేయబడుతుంది.",
        "<b>వ్యక్తి</b> పై క్లిక్ చేస్తే ఆ తరం సోదర సోదరీమణులు విస్తరిస్తారు. ఇది టాగుల్ స్విచ్ <b>(విస్తరించు / మూసివేయి)</b>. మీరు వృక్షంలో లోతుగా వెళ్లవచ్చు.",
        "<b>ఫోటో</b> పై క్లిక్ చేస్తే ఆ వ్యక్తి భార్య/భర్త వృక్షం (ఉంటే) / ఆ వ్యక్తి వృక్షం వెళ్తుంది",
        "<b>హోమ్</b> పై క్లిక్ చేస్తే అనుబంధాల జాబితాకు వెళ్తుంది.",
        "ఒకటి కంటే ఎక్కువ భార్యలు/భర్తలు ఉన్న వారి కోసం, <b>భార్య/భర్త పేరు</b> పై క్లిక్ చేస్తే వృక్షం మారుతుంది."
    ],
    langStatus: "తెలుగు"
};

function getCurrentButtonTexts() {
    return isTelugu ? buttonTexts.telugu : buttonTexts.english;
}

function updateButtons() {
    const texts = getCurrentButtonTexts();
    const expandBtn = document.getElementById('expandAllToggle');
    
    // ✅ FIXED: Check current button text against CURRENT language texts
    const isExpandState = expandBtn.textContent === texts.expandAll || 
                         expandBtn.textContent === buttonTexts.english.expandAll;
    
    expandBtn.textContent = isExpandState ? texts.collapseAll : texts.expandAll;
    
    document.getElementById('paternalBtn').textContent = texts.paternal;
    document.getElementById('maternalBtn').textContent = texts.maternal;
    document.getElementById('homeBtn').textContent = texts.home;
    document.getElementById('searchBox').placeholder = texts.searchPlaceholder;
}

function toggleLanguage() {
    isTelugu = !isTelugu;
    document.body.classList.toggle('telugu', isTelugu);
    
    const texts = isTelugu ? teluguTexts : englishTexts;
    document.getElementById('screenTitle').textContent = texts.title;
    
    const list = document.getElementById('instructionsList');
    list.innerHTML = texts.instructions.map(text => `<li>${text}</li>`).join('');
    
    document.getElementById('langStatus').textContent = texts.langStatus;
    document.getElementById('arraycount').innerHTML = gvss.length;
    
    updateButtons();
    
    if (typeof initializeData === 'function') {
        initializeData();
    }
}

let data = [];
let persons = {};
let selectedPersonId = null;
let currentPersonId = null;

const screen1 = document.getElementById("screen1");
const screen2 = document.getElementById("screen2");
const treeDiv = document.getElementById("tree");
const expandBtn = document.getElementById("expandAllToggle");

/* --------------------------------------------------------------
CREATE DUAL SURNAMES ARRAY - ENGLISH + TELUGU
-------------------------------------------------------------- */
function createSurnameMap() {
    const surnameMap = new Map();
    
    data.forEach(p => {
        if (p.engName) {
            const engSurname = p.engName.split(" ")[0];
            if (!surnameMap.has(engSurname)) {
                surnameMap.set(engSurname, {
                    engSurname: engSurname,
                    telSurname: '',
                    count: 0
                });
            }
            const entry = surnameMap.get(engSurname);
            entry.count++;
            
            if (!entry.telSurname && p.telName && p.telName.trim()) {
                const telWords = p.telName.trim().split(/[\s\u200C-\u200F\u3000]/);
                entry.telSurname = telWords[0] || engSurname;
            }
        }
    });
    
    return Array.from(surnameMap.values());
}

/* --------------------------------------------------------------
AUTO PHOTO DETECTION + DATA PARSING
-------------------------------------------------------------- */
const raw = gvss;
async function getPhotoAvailability() {
    try {
        const response = await fetch('https://api.github.com/repos/gvssmark/FamTree/contents/photos?ref=main');
        const files = await response.json();
        const photoSet = new Set(
            files.map(f => parseInt(f.name.replace('.JPG', ''))).filter(id => !isNaN(id))
        );
        return photoSet;
    } catch (e) {
        console.warn('Photo API failed, using no photos:', e);
        return new Set();
    }
}

async function initializeData() {
    const photoSet = await getPhotoAvailability();
    
    data = raw.slice(1).map(r => ({
        id: Number(r[0]),
        engName: r[1],
        telName: r[9] || r[1],
        name: isTelugu ? (r[9] || r[1]) : r[1],
        gender: r[2],
        father: r[3] ? Number(r[3]) : null,
        mother: r[4] ? Number(r[4]) : null,
        spouse: r[5] ? Number(r[5]) : null,
        dob: r[6],
        photoAvailable: photoSet.has(Number(r[0]))
    }));

    persons = {};
    data.forEach(p => persons[p.id] = {...p, children:[]});
    data.forEach(p => {
        if(p.father && persons[p.father]) persons[p.father].children.push(p.id);
        if(p.mother && persons[p.mother]) persons[p.mother].children.push(p.id);
    });

    document.getElementById('arraycount').innerHTML = data.length;
    console.log(`✅ Loaded ${data.length} people, ${photoSet.size} have photos`);
    if (document.getElementById("title")) {
        document.getElementById("title").textContent = `Family Tree (${photoSet.size} photos loaded)`;
    }

    screen1.innerHTML = "";
    initializeUI();
}

/* --------------------------------------------------------------
UI SCREENS - DUAL SURNAMES DISPLAY
-------------------------------------------------------------- */
function initializeUI() {
    const surnameList = createSurnameMap();
    
    surnameList.forEach(surnameEntry => {
        const d = document.createElement("div");
        d.className = "surname";
        
        d.textContent = isTelugu ? surnameEntry.telSurname : surnameEntry.engSurname;
        d.title = `${surnameEntry.engSurname} (${surnameEntry.count} members)`;
        
        d.onclick = () => showMembers(surnameEntry.engSurname);
        screen1.appendChild(d);
    });
    
    window.scrollTo(0, 0);
}

function showMembers(engSurname) {
    const texts = getCurrentButtonTexts();
    setTitle(`Members of ${engSurname}`);
    screen1.style.display = "none";
    screen2.style.display = "block";
    screen2.innerHTML = "";

    data
        .filter(p => p.engName && p.engName.startsWith(engSurname))
        .sort((a, b) => a.engName.localeCompare(b.engName))
        .forEach(p => {
            const d = document.createElement("div");
            d.className = "member";
            d.textContent = p.name;
            d.onclick = () => showMemberOptions(p.id);
            screen2.appendChild(d);
        });

    setButtonsEnabled(false);
    treeDiv.style.display = "none";
    window.scrollTo(0, 0);
}

function showMemberOptions(id) {
    currentPersonId = id;
    selectedPersonId = id;
    setButtonsEnabled(true);
    showRootAncestor(id, "father");
}

function showRootAncestor(id, side) {
    selectedPersonId = id;
    let root = persons[id];
    while (root && root[side]) root = persons[root[side]];
    if (!root) root = persons[id];
    
    const texts = getCurrentButtonTexts();
    const prefix = side === "father" ? texts.paternal : texts.maternal;
    setTitle(`${prefix} Tree of ${persons[id].name}`);
    screen1.style.display = "none";
    screen2.style.display = "none";
    treeDiv.style.display = "block";
    treeDiv.innerHTML = "";
    treeDiv.appendChild(buildNode(root, 0));
    setButtonsEnabled(true);
    scrollToHighlightedPerson();
}

/* --------------------------------------------------------------
TREE BUILDING
-------------------------------------------------------------- */
function getSpouses(id) {
    return data.filter(p => p.spouse === id);
}

const noImageUrl = 'https://github.com/gvssmark/FamTree/blob/main/photos/noimage.PNG?raw=true';
const imgCache = {};
(function() { const img = new Image(); img.src = noImageUrl; imgCache['noimage'] = { status: 'loaded', img }; })();

function loadImageById(id) {
    if (!id) return Promise.resolve(imgCache['noimage'].img);
    const key = String(id);
    if (imgCache[key]) {
        if (imgCache[key].status === 'loaded') return Promise.resolve(imgCache[key].img);
        return imgCache[key].promise;
    }
    const img = new Image();
    const p = new Promise(res => {
        img.onload = () => { imgCache[key].status = 'loaded'; imgCache[key].img = img; res(img); };
        img.onerror = () => { imgCache[key].status = 'error'; imgCache[key].img = imgCache['noimage'].img; res(imgCache['noimage'].img); };
    });
    imgCache[key] = { status: 'loading', img: null, promise: p };
    img.src = `https://gvssmark.github.io/FamTree/photos/${id}.JPG`;
    return p;
}

const genBadgeColors = ["#000", "#1a73e8", "#0f9d58", "#f4b400", "#db4437", "#673ab7", "#0097a7", "#5c6bc0", "#795548"];
const genNodeColors = ["#f0f0f0", "#e0f2ff", "#e0ffe0", "#fff8e0", "#ffe0e0", "#f3e0ff", "#e0ffff", "#e8eaf6", "#f5f5dc"];

function formatDOB(dob) {
    if (!dob) return "";
    return new Date(dob).toLocaleDateString("en-US", { month: "short", day: "numeric" });
}

function buildNode(person, level) {
    const wrap = document.createElement("div");
    const node = document.createElement("div");
    node.className = "node";
    node.style.background = genNodeColors[level] || "#f0f0f0";

    const badge = document.createElement("div");
    badge.className = "gen-badge-circle";
    badge.textContent = "G" + level;
    badge.style.background = genBadgeColors[level] || "#000";
    node.appendChild(badge);

    const photo = document.createElement("img");
    photo.className = "photo";
    photo.src = imgCache['noimage'].img.src;
    if (person.photoAvailable) {
        loadImageById(person.id).then(img => photo.src = img.src);
    }

    const textDiv = document.createElement("div");
    textDiv.className = "text";
    let nameLine = `<b>${person.name} <span class='idno'>(${person.id})</span></b>`;
    textDiv.innerHTML = nameLine;

    node.appendChild(photo);
    node.appendChild(textDiv);

    if (person.id === selectedPersonId) node.classList.add("search-highlight");

    let spouseSet = new Map();
    getSpouses(person.id).forEach(s => spouseSet.set(s.id, s));
    if (person.spouse && persons[person.spouse]) {
        spouseSet.set(person.spouse, persons[person.spouse]);
    }
    let spouseList = Array.from(spouseSet.values());
    const hasSingleSpouse = spouseList.length === 1;
    const hasMultipleSpouses = spouseList.length > 1;

    spouseList.forEach(sp => {
        const spLine = document.createElement("div");
        spLine.style.color = "blue";
        spLine.textContent = sp.name;
        if (hasMultipleSpouses) {
            spLine.style.cursor = "pointer";
            spLine.onclick = ev => {
                ev.stopPropagation();
                currentPersonId = sp.id;
                selectedPersonId = sp.id;
                showRootAncestor(sp.id, "father");
            };
        } else {
            spLine.style.cursor = "default";
        }
        textDiv.appendChild(spLine);
    });

    photo.classList.add("clickable");
    if (!hasMultipleSpouses) {
        const targetId = hasSingleSpouse ? spouseList[0].id : person.id;
        photo.onclick = ev => {
            ev.stopPropagation();
            currentPersonId = targetId;
            selectedPersonId = targetId;
            showRootAncestor(targetId, "father");
        };
    } else {
        photo.onclick = ev => {
            ev.stopPropagation();
            currentPersonId = person.id;
            selectedPersonId = person.id;
            showRootAncestor(person.id, "father");
        };
    }

    let slideshowIds = [person.id, ...spouseList.map(s => s.id)].filter(id => {
        const personData = persons[id];
        return personData && personData.photoAvailable === true;
    });
    if (slideshowIds.length > 1) {
        let slideIndex = 0;
        setInterval(() => {
            loadImageById(slideshowIds[slideIndex]).then(img => {
                photo.src = img.src;
                if (!hasMultipleSpouses) {
                    const targetId = hasSingleSpouse ? spouseList[0].id : person.id;
                    photo.onclick = ev => {
                        ev.stopPropagation();
                        currentPersonId = targetId;
                        selectedPersonId = targetId;
                        showRootAncestor(targetId, "father");
                    };
                } else {
                    photo.onclick = ev => {
                        ev.stopPropagation();
                        currentPersonId = person.id;
                        selectedPersonId = person.id;
                        showRootAncestor(person.id, "father");
                    };
                }
            });
            slideIndex = (slideIndex + 1) % slideshowIds.length;
        }, 3000);
    }

    const kids = document.createElement("div");
    kids.className = "children collapsed";
    node.onclick = ev => {
        ev.stopPropagation();
        kids.classList.toggle("collapsed");
        kids.classList.toggle("expanded");
    };
    persons[person.id].children.forEach(cid => {
        kids.appendChild(buildNode(persons[cid], level + 1));
    });

    wrap.appendChild(node);
    if (person.children.length > 0) wrap.appendChild(kids);
    return wrap;
}

function scrollToHighlightedPerson() {
    setTimeout(() => {
        const node = document.querySelector(".search-highlight");
        if (node) node.scrollIntoView({ behavior: "smooth", block: "center" });
    }, 300);
}

/* BUTTONS - FIXED EXPAND/COLLAPSE LOGIC */
const paternalBtn = document.getElementById("paternalBtn");
const maternalBtn = document.getElementById("maternalBtn");

document.getElementById("homeBtn").onclick = () => {
    const texts = getCurrentButtonTexts();
    setTitle("Family Tree");
    screen1.style.display = "grid";
    screen2.style.display = "none";
    treeDiv.style.display = "none";
    setButtonsEnabled(false);
    expandBtn.textContent = texts.expandAll;
    updateButtons();
    initializeUI();
};

paternalBtn.onclick = () => { 
    currentPersonId && showRootAncestor(currentPersonId, "father"); 
};
maternalBtn.onclick = () => { 
    currentPersonId && showRootAncestor(currentPersonId, "mother"); 
};

function setTitle(t) { 
    document.getElementById("title").textContent = t; 
}
function setButtonsEnabled(en) { 
    paternalBtn.disabled = maternalBtn.disabled = expandBtn.disabled = !en; 
}

// ✅ FIXED EXPAND/COLLAPSE LOGIC - Works in BOTH languages
expandBtn.onclick = () => {
    const texts = getCurrentButtonTexts();
    const currentBtnText = expandBtn.textContent;
    
    // ✅ Check if current text matches CURRENT language's "Expand All"
    const shouldExpand = currentBtnText === texts.expandAll;
    
    document.querySelectorAll(".children").forEach(c => {
        c.classList.remove("collapsed", "expanded");
        c.classList.add(shouldExpand ? "expanded" : "collapsed");
    });
    
    // ✅ Set correct text for NEXT state
    expandBtn.textContent = shouldExpand ? texts.collapseAll : texts.expandAll;
    
    if (shouldExpand) scrollToHighlightedPerson();
};

/* SEARCH */
const searchBox = document.getElementById("searchBox");
const searchResults = document.getElementById("searchResults");
document.addEventListener("click", () => searchResults.style.display = "none");

searchBox.oninput = () => {
    const q = searchBox.value.trim().toLowerCase();
    searchResults.innerHTML = "";
    if (!q) { searchResults.style.display = "none"; return; }
    let matches = data.filter(p => p.name.toLowerCase().includes(q));
    matches.sort((a, b) => a.name.localeCompare(b.name));
    matches.forEach(p => {
        const item = document.createElement("div");
        item.className = "search-item";
        item.textContent = p.name;
        item.onclick = ev => {
            ev.stopPropagation();
            searchResults.style.display = "none";
            searchBox.value = "";
            selectedPersonId = p.id;
            currentPersonId = p.id;
            showRootAncestor(p.id, "father");
        };
        searchResults.appendChild(item);
    });
    searchResults.style.display = "block";
};

/* INITIALIZATION */
document.getElementById('arraycount').innerHTML = gvss.length;
document.getElementById('continueBtn').onclick = function() {
    const texts = getCurrentButtonTexts();
    document.getElementById('screen0').style.display = 'none';
    document.querySelector('.topbar').style.display = 'flex';
    setTitle("Family Tree");
    screen1.style.display = "grid";
    screen2.style.display = "none";
    treeDiv.style.display = "none";
    setButtonsEnabled(false);
    expandBtn.textContent = texts.expandAll;
    updateButtons();
    initializeData();
};

initializeData();
</script>
</body>
</html>
